local UserInputService = game:GetService("UserInputService")
local PlayerGui = game.Players.LocalPlayer:WaitForChild("PlayerGui")
local TweenService = game:GetService("TweenService")

local Library = {}
Library.NotificationsEnabled = true

-- 1. ЦВЕТА И ТЕМЫ
local THEMES = {
    Default = {Background = Color3.fromRGB(210, 204, 180), Sidebar = Color3.fromRGB(200, 195, 170), Accent = Color3.fromRGB(85, 80, 70), Text = Color3.fromRGB(60, 55, 50), Row = Color3.fromRGB(190, 185, 160), Hover = Color3.fromRGB(170, 165, 140)},
    Purple = {Background = Color3.fromRGB(230, 220, 235), Sidebar = Color3.fromRGB(215, 205, 225), Accent = Color3.fromRGB(120, 100, 140), Text = Color3.fromRGB(70, 60, 85), Row = Color3.fromRGB(205, 195, 215), Hover = Color3.fromRGB(185, 175, 200)},
    Green = {Background = Color3.fromRGB(220, 235, 220), Sidebar = Color3.fromRGB(205, 220, 205), Accent = Color3.fromRGB(100, 130, 100), Text = Color3.fromRGB(55, 75, 55), Row = Color3.fromRGB(195, 210, 195), Hover = Color3.fromRGB(175, 190, 175)},
    Blue = {Background = Color3.fromRGB(215, 225, 235), Sidebar = Color3.fromRGB(200, 210, 225), Accent = Color3.fromRGB(90, 115, 140), Text = Color3.fromRGB(50, 65, 85), Row = Color3.fromRGB(190, 200, 215), Hover = Color3.fromRGB(170, 185, 200)}
}

local CURRENT_THEME = THEMES.Default
local hoverSound = Instance.new("Sound")
hoverSound.SoundId = "rbxassetid://101687010700348"
hoverSound.Volume = 0.5
hoverSound.Parent = game:GetService("SoundService")

-- Функция обновления визуалов при смене темы
local function updateVisuals(root)
    local ti = TweenInfo.new(0.3)
    for _, obj in pairs(root:GetDescendants()) do
        if obj.Name == "Sidebar" then TweenService:Create(obj, ti, {BackgroundColor3 = CURRENT_THEME.Sidebar}):Play()
        elseif obj.Name == "RowFrame" or obj.Name == "ParagraphFrame" then TweenService:Create(obj, ti, {BackgroundColor3 = CURRENT_THEME.Row}):Play()
        elseif obj.Name == "AccentPart" or obj.Name == "HeaderPart" then TweenService:Create(obj, ti, {BackgroundColor3 = CURRENT_THEME.Accent}):Play()
        elseif obj:IsA("TextLabel") and obj.Name ~= "WhiteText" and obj.Name ~= "MainTitle" then TweenService:Create(obj, ti, {TextColor3 = CURRENT_THEME.Text}):Play()
        end
    end
end

-- Система уведомлений
function Library:Notify(titleText, descText, duration)
    if not Library.NotificationsEnabled or not Library.NotifyContainer then return end
    
    local notificationFrame = Instance.new("Frame", Library.NotifyContainer)
    notificationFrame.Name = "ParagraphFrame"
    notificationFrame.Size = UDim2.new(0, 280, 0, 70)
    notificationFrame.BackgroundColor3 = CURRENT_THEME.Row
    notificationFrame.BorderSizePixel = 0
    
    local accentBar = Instance.new("Frame", notificationFrame)
    accentBar.Name = "AccentPart"
    accentBar.Size = UDim2.new(1, 0, 0, 4)
    accentBar.Position = UDim2.new(0, 0, 1, -4)
    accentBar.BackgroundColor3 = CURRENT_THEME.Accent
    accentBar.BorderSizePixel = 0
    
    local titleLabel = Instance.new("TextLabel", notificationFrame)
    titleLabel.Text = "  " .. titleText:upper()
    titleLabel.Size = UDim2.new(1, 0, 0, 25)
    titleLabel.TextColor3 = CURRENT_THEME.Accent
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 14
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.BackgroundTransparency = 1
    
    local descLabel = Instance.new("TextLabel", notificationFrame)
    descLabel.Text = "  " .. descText
    descLabel.Size = UDim2.new(1, 0, 1, -25)
    descLabel.Position = UDim2.new(0, 0, 0, 25)
    descLabel.TextColor3 = CURRENT_THEME.Text
    descLabel.Font = Enum.Font.Gotham
    descLabel.TextSize = 13
    descLabel.TextXAlignment = Enum.TextXAlignment.Left
    descLabel.TextYAlignment = Enum.TextYAlignment.Top
    descLabel.BackgroundTransparency = 1
    
    task.delay(duration or 3, function()
        notificationFrame:Destroy()
    end)
end

function Library:CreateWindow(titleText, sidebarTitle)
    local windowData = {Tabs = {}, IsMenuOpen = false}
    
    local screenGui = Instance.new("ScreenGui", PlayerGui)
    screenGui.Name = "RebellionLib_" .. math.random(1, 100)
    screenGui.ResetOnSpawn = false
    
    local mainFrame = Instance.new("Frame", screenGui)
    mainFrame.Size = UDim2.new(0, 800, 0, 420)
    mainFrame.Position = UDim2.new(0.5, -400, 0.5, -210)
    mainFrame.BackgroundColor3 = CURRENT_THEME.Background
    mainFrame.BorderSizePixel = 0
    
    local topBar = Instance.new("Frame", mainFrame)
    topBar.Size = UDim2.new(1, 0, 0, 35)
    topBar.BackgroundColor3 = CURRENT_THEME.Accent
    topBar.BorderSizePixel = 0
    
    local mainTitle = Instance.new("TextLabel", topBar)
    mainTitle.Name = "MainTitle"
    mainTitle.Text = "  " .. titleText:upper()
    mainTitle.Size = UDim2.new(1, 0, 1, 0)
    mainTitle.TextColor3 = CURRENT_THEME.Background
    mainTitle.Font = Enum.Font.GothamBold
    mainTitle.TextSize = 18
    mainTitle.TextXAlignment = Enum.TextXAlignment.Left
    mainTitle.BackgroundTransparency = 1
    
    local sidebar = Instance.new("Frame", mainFrame)
    sidebar.Name = "Sidebar"
    sidebar.Size = UDim2.new(0, 180, 1, -35)
    sidebar.Position = UDim2.new(0, 0, 0, 35)
    sidebar.BackgroundColor3 = CURRENT_THEME.Sidebar
    sidebar.BorderSizePixel = 0
    
    local sidebarTitleLabel = Instance.new("TextLabel", sidebar)
    sidebarTitleLabel.Text = sidebarTitle:upper()
    sidebarTitleLabel.Size = UDim2.new(1, 0, 0, 45)
    sidebarTitleLabel.TextColor3 = CURRENT_THEME.Accent
    sidebarTitleLabel.Font = Enum.Font.GothamBold
    sidebarTitleLabel.TextSize = 14
    sidebarTitleLabel.BackgroundTransparency = 1
    
    local tabContainer = Instance.new("Frame", sidebar)
    tabContainer.Size = UDim2.new(1, 0, 1, -50)
    tabContainer.Position = UDim2.new(0, 0, 0, 50)
    tabContainer.BackgroundTransparency = 1
    
    local contentArea = Instance.new("Frame", mainFrame)
    contentArea.Size = UDim2.new(1, -190, 1, -45)
    contentArea.Position = UDim2.new(0, 190, 0, 45)
    contentArea.BackgroundTransparency = 1
    
    local notifyContainer = Instance.new("Frame", screenGui)
    notifyContainer.Size = UDim2.new(0, 300, 1, -20)
    notifyContainer.Position = UDim2.new(1, -310, 0, 10)
    notifyContainer.BackgroundTransparency = 1
    Instance.new("UIListLayout", notifyContainer).VerticalAlignment = Enum.VerticalAlignment.Bottom
    Library.NotifyContainer = notifyContainer

    -- Универсальный Dropdown контейнер (то самое меню выбора)
    local dimFrame = Instance.new("Frame", mainFrame)
    dimFrame.Size = UDim2.new(1, 0, 1, 0)
    dimFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    dimFrame.BackgroundTransparency = 1
    dimFrame.ZIndex = 80
    dimFrame.Visible = false
    
    local selectModeGui = Instance.new("Frame", mainFrame)
    selectModeGui.Name = "RowFrame"
    selectModeGui.Size = UDim2.new(0, 320, 0, 240)
    selectModeGui.Position = UDim2.new(0.5, 0, 0.5, 0)
    selectModeGui.AnchorPoint = Vector2.new(0.5, 0.5)
    selectModeGui.ZIndex = 90
    selectModeGui.Visible = false
    selectModeGui.BorderSizePixel = 0
    
    local modeContainer = Instance.new("Frame", selectModeGui)
    modeContainer.Size = UDim2.new(1, -20, 1, -40)
    modeContainer.Position = UDim2.new(0, 10, 0, 40)
    modeContainer.BackgroundTransparency = 1
    modeContainer.ZIndex = 91
    Instance.new("UIListLayout", modeContainer).Padding = UDim.new(0, 5)

    function windowData:CreateTab(tabName)
        local tabObj = {}
        local tabButton = Instance.new("TextButton", tabContainer)
        tabButton.Name = "SidebarBtn"
        tabButton.Size = UDim2.new(1, 0, 0, 45)
        tabButton.Position = UDim2.new(0, 0, 0, #windowData.Tabs * 45)
        tabButton.BackgroundColor3 = CURRENT_THEME.Sidebar
        tabButton.BorderSizePixel = 0
        tabButton.Text = ""
        
        local tabIcon = Instance.new("Frame", tabButton)
        tabIcon.Name = "AccentPart"
        tabIcon.Size = UDim2.new(0, 12, 0, 12)
        tabIcon.Position = UDim2.new(0, 15, 0.5, -6)
        tabIcon.BackgroundColor3 = CURRENT_THEME.Accent
        tabIcon.Rotation = 45
        tabIcon.BorderSizePixel = 0
        
        local tabLabel = Instance.new("TextLabel", tabButton)
        tabLabel.Text = tabName
        tabLabel.Size = UDim2.new(1, -42, 1, 0)
        tabLabel.Position = UDim2.new(0, 42, 0, 0)
        tabLabel.TextColor3 = CURRENT_THEME.Text
        tabLabel.Font = Enum.Font.GothamBold
        tabLabel.TextSize = 16
        tabLabel.BackgroundTransparency = 1
        tabLabel.TextXAlignment = Enum.TextXAlignment.Left
        
        local page = Instance.new("ScrollingFrame", contentArea)
        page.Size = UDim2.new(1, 0, 1, 0)
        page.BackgroundTransparency = 1
        page.BorderSizePixel = 0
        page.Visible = false
        page.ScrollBarThickness = 0
        Instance.new("UIListLayout", page).Padding = UDim.new(0, 8)
        
        tabButton.MouseButton1Click:Connect(function()
            hoverSound:Play()
            for _, t in pairs(windowData.Tabs) do t.Page.Visible = false end
            page.Visible = true
        end)
        
        tabObj.Page = page
        table.insert(windowData.Tabs, tabObj)
        if #windowData.Tabs == 1 then page.Visible = true end
        
        -- ВОТ ЭТИ МЕТОДЫ БЫЛИ УТЕРЯНЫ:
        
        function tabObj:Paragraph(titleText, descText)
            local frame = Instance.new("Frame", page)
            frame.Name = "ParagraphFrame"
            frame.Size = UDim2.new(0, 580, 0, 80)
            frame.BackgroundColor3 = CURRENT_THEME.Row
            frame.BorderSizePixel = 0
            
            local header = Instance.new("Frame", frame)
            header.Name = "HeaderPart"
            header.Size = UDim2.new(1, 0, 0, 25)
            header.BackgroundColor3 = CURRENT_THEME.Accent
            header.BorderSizePixel = 0
            
            local hTitle = Instance.new("TextLabel", header)
            hTitle.Name = "WhiteText"
            hTitle.Text = "  " .. titleText
            hTitle.Size = UDim2.new(1, 0, 1, 0)
            hTitle.TextColor3 = Color3.new(1, 1, 1)
            hTitle.Font = Enum.Font.GothamBold
            hTitle.TextSize = 14
            hTitle.TextXAlignment = Enum.TextXAlignment.Left
            hTitle.BackgroundTransparency = 1
            
            local desc = Instance.new("TextLabel", frame)
            desc.Text = descText
            desc.Size = UDim2.new(1, -20, 1, -35)
            desc.Position = UDim2.new(0, 10, 0, 30)
            desc.TextColor3 = CURRENT_THEME.Text
            desc.Font = Enum.Font.Gotham
            desc.TextSize = 14
            desc.TextWrapped = true
            desc.TextXAlignment = Enum.TextXAlignment.Left
            desc.TextYAlignment = Enum.TextYAlignment.Top
            desc.BackgroundTransparency = 1
            frame.Size = UDim2.new(0, 580, 0, desc.TextBounds.Y + 45)
        end
        
        function tabObj:Button(name, callback)
            local frame = Instance.new("TextButton", page)
            frame.Name = "RowFrame"
            frame.Size = UDim2.new(0, 350, 0, 48)
            frame.BackgroundColor3 = CURRENT_THEME.Row
            frame.BorderSizePixel = 0
            frame.Text = ""
            
            local box = Instance.new("Frame", frame)
            box.Name = "AccentPart"
            box.Size = UDim2.new(0, 14, 0, 14)
            box.Position = UDim2.new(0, 15, 0.5, -7)
            box.BackgroundColor3 = CURRENT_THEME.Accent
            box.BorderSizePixel = 0
            
            local lbl = Instance.new("TextLabel", frame)
            lbl.Text = name
            lbl.Size = UDim2.new(0.6, 0, 1, 0)
            lbl.Position = UDim2.new(0, 45, 0, 0)
            lbl.TextColor3 = CURRENT_THEME.Text
            lbl.Font = Enum.Font.GothamBold
            lbl.TextSize = 16
            lbl.BackgroundTransparency = 1
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            
            frame.MouseButton1Click:Connect(function()
                hoverSound:Play()
                callback()
            end)
        end
        
        function tabObj:Toggle(name, default, callback)
            local frame = Instance.new("TextButton", page)
            frame.Name = "RowFrame"
            frame.Size = UDim2.new(0, 350, 0, 48)
            frame.BackgroundColor3 = CURRENT_THEME.Row
            frame.BorderSizePixel = 0
            frame.Text = ""
            
            local box = Instance.new("Frame", frame)
            box.Name = "AccentPart"
            box.Size = UDim2.new(0, 14, 0, 14)
            box.Position = UDim2.new(0, 15, 0.5, -7)
            box.BackgroundColor3 = CURRENT_THEME.Accent
            box.BorderSizePixel = 0
            
            local lbl = Instance.new("TextLabel", frame)
            lbl.Text = name
            lbl.Size = UDim2.new(0.6, 0, 1, 0)
            lbl.Position = UDim2.new(0, 45, 0, 0)
            lbl.TextColor3 = CURRENT_THEME.Text
            lbl.Font = Enum.Font.GothamBold
            lbl.TextSize = 16
            lbl.BackgroundTransparency = 1
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            
            local tBox = Instance.new("Frame", frame)
            tBox.Name = "AccentPart"
            tBox.Size = UDim2.new(0, 65, 0, 30)
            tBox.Position = UDim2.new(1, -75, 0.5, -15)
            tBox.BackgroundColor3 = CURRENT_THEME.Accent
            tBox.ClipsDescendants = true
            tBox.BorderSizePixel = 0
            
            local tTxt = Instance.new("TextLabel", tBox)
            tTxt.Name = "WhiteText"
            tTxt.Size = UDim2.new(2, 0, 1, 0)
            tTxt.Position = default and UDim2.new(0, 0, 0, 0) or UDim2.new(-1, 0, 0, 0)
            tTxt.Text = "ON      OFF"
            tTxt.TextColor3 = Color3.new(1, 1, 1)
            tTxt.Font = Enum.Font.GothamBold
            tTxt.TextSize = 14
            tTxt.BackgroundTransparency = 1
            
            local state = default
            frame.MouseButton1Click:Connect(function()
                hoverSound:Play()
                state = not state
                TweenService:Create(tTxt, TweenInfo.new(0.25), {Position = state and UDim2.new(0, 0, 0, 0) or UDim2.new(-1, 0, 0, 0)}):Play()
                callback(state)
            end)
        end
        
        function tabObj:Bind(name, defaultKey, callback)
            local frame = Instance.new("TextButton", page)
            frame.Name = "RowFrame"
            frame.Size = UDim2.new(0, 350, 0, 48)
            frame.BackgroundColor3 = CURRENT_THEME.Row
            frame.BorderSizePixel = 0
            frame.Text = ""
            
            local box = Instance.new("Frame", frame)
            box.Name = "AccentPart"
            box.Size = UDim2.new(0, 14, 0, 14)
            box.Position = UDim2.new(0, 15, 0.5, -7)
            box.BackgroundColor3 = CURRENT_THEME.Accent
            box.BorderSizePixel = 0
            
            local lbl = Instance.new("TextLabel", frame)
            lbl.Text = name
            lbl.Size = UDim2.new(0.6, 0, 1, 0)
            lbl.Position = UDim2.new(0, 45, 0, 0)
            lbl.TextColor3 = CURRENT_THEME.Text
            lbl.Font = Enum.Font.GothamBold
            lbl.TextSize = 16
            lbl.BackgroundTransparency = 1
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            
            local bLbl = Instance.new("TextLabel", frame)
            bLbl.Name = "HeaderPart"
            bLbl.Size = UDim2.new(0, 100, 0, 30)
            bLbl.Position = UDim2.new(1, -110, 0.5, -15)
            bLbl.BackgroundColor3 = CURRENT_THEME.Accent
            bLbl.TextColor3 = Color3.new(1, 1, 1)
            bLbl.Text = defaultKey.Name
            bLbl.Font = Enum.Font.GothamBold
            bLbl.TextSize = 14
            bLbl.BorderSizePixel = 0
            
            local currentKey = defaultKey
            frame.MouseButton1Click:Connect(function()
                bLbl.Text = "..."
                local connection
                connection = UserInputService.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.Keyboard then
                        currentKey = input.KeyCode
                        bLbl.Text = currentKey.Name
                        connection:Disconnect()
                    end
                end)
            end)
            UserInputService.InputBegan:Connect(function(i, g) if not g and i.KeyCode == currentKey then callback() end end)
        end
        
        function tabObj:Dropdown(name, list, callback)
            local frame = Instance.new("TextButton", page)
            frame.Name = "RowFrame"
            frame.Size = UDim2.new(0, 350, 0, 48)
            frame.BackgroundColor3 = CURRENT_THEME.Row
            frame.BorderSizePixel = 0
            frame.Text = ""
            
            local lbl = Instance.new("TextLabel", frame)
            lbl.Text = name
            lbl.Size = UDim2.new(0.6, 0, 1, 0)
            lbl.Position = UDim2.new(0, 45, 0, 0)
            lbl.TextColor3 = CURRENT_THEME.Text
            lbl.Font = Enum.Font.GothamBold
            lbl.TextSize = 16
            lbl.BackgroundTransparency = 1
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            
            local valLbl = Instance.new("TextLabel", frame)
            valLbl.Name = "HeaderPart"
            valLbl.Size = UDim2.new(0, 100, 0, 30)
            valLbl.Position = UDim2.new(1, -110, 0.5, -15)
            valLbl.BackgroundColor3 = CURRENT_THEME.Accent
            valLbl.TextColor3 = Color3.new(1, 1, 1)
            valLbl.Text = "Select..."
            valLbl.Font = Enum.Font.GothamBold
            valLbl.TextSize = 14
            
            frame.MouseButton1Click:Connect(function()
                for _, child in pairs(modeContainer:GetChildren()) do if child:IsA("TextButton") then child:Destroy() end end
                windowData.IsMenuOpen = true; dimFrame.Visible = true; selectModeGui.Visible = true
                for _, item in pairs(list) do
                    local itemBtn = Instance.new("TextButton", modeContainer)
                    itemBtn.Name = "RowFrame"; itemBtn.Size = UDim2.new(1, 0, 0, 40)
                    itemBtn.BackgroundColor3 = CURRENT_THEME.Row; itemBtn.Text = item
                    itemBtn.TextColor3 = CURRENT_THEME.Text; itemBtn.Font = Enum.Font.GothamBold; itemBtn.ZIndex = 95
                    itemBtn.MouseButton1Click:Connect(function()
                        valLbl.Text = item; callback(item)
                        windowData.IsMenuOpen = false; dimFrame.Visible = false; selectModeGui.Visible = false
                    end)
                end
            end)
        end
        
        return tabObj
    end
    
    -- Авто-вкладка настроек
    local settingsTab = windowData:CreateTab("Settings")
    settingsTab:Dropdown("Change Theme", {"Default", "Purple", "Green", "Blue"}, function(selected)
        CURRENT_THEME = THEMES[selected]
        updateVisuals(screenGui)
        mainFrame.BackgroundColor3 = CURRENT_THEME.Background
        mainTitle.TextColor3 = CURRENT_THEME.Background
    end)
    settingsTab:Toggle("Enable Notifications", true, function(state)
        Library.NotificationsEnabled = state
    end)

    return windowData
end

return Library
